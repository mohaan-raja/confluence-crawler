<h1>Title: Trinity</h1><h3 id="Trinity-ProductBrief:"><strong>Product Brief:</strong></h3><p style="margin-left: 30.0px;">For those who aren't aware about Trinity, Trinity was built intending for the purpose of sync between two products.<br/>Currently we have on-boarded Google Contacts sync into trinity(One way - From Google Contacts to Freshsales).</p><p style="margin-left: 30.0px;">And the sync includes:</p><ol><li style="list-style-type: none;background-image: none;"><ol><li>Historic sync</li><li>Scheduled sync(every 30 mins)</li><li>Triggered sync(When explicitly triggered by the customer)</li></ol></li></ol><p style="margin-left: 30.0px;">We do the oauth sign-in from the customer and then pull the data in lists i.e., whichever list he chooses in Google Contacts we pull the data accordingly.<br/>This comes with couple of options available:</p><ol><li style="list-style-type: none;background-image: none;"><ol><li>Create/update only to leads</li><li>Create/update only to contacts</li><li>Create/update only to both leads and contacts.</li></ol></li></ol><h3 id="Trinity-Outage:">Outage:</h3><p style="margin-left: 30.0px;">The customer count having Google Contacts increased over the months and reached ~617 with some more suspended accounts as well. To maintain a good health of the product, Vijay(Vijayaragavan V) and me started having weekly time dedicated to Trinity to check if the syncs are in good shape with less/no errors. </p><p style="margin-left: 30.0px;">Amidst → Two customers came in support saying their sync is not happening from more than a day then. We checked the logs - all good but sync was not happening</p><p style="margin-left: 30.0px;">Vijay, Vaidhy(Vaidhyanathan A) and me started looking into the issue. Thanks to Vijay for breaking and narrowing down the issue possibilities while me and Vaidhy checking the code possibilities.</p><ul class="inline-task-list" data-inline-tasks-content-id="210027163"><li style="background-image: none;"><ul class="inline-task-list" data-inline-tasks-content-id="210027163"><li class="checked" data-inline-task-id="16"><strong>Step 1 - Checked the Instance logs, haystack logs - all good</strong><br/><strong><br/></strong></li><li class="checked" data-inline-task-id="17"><strong>Step 2 - Checked the code - No primary/usual suspects</strong><br/><strong><br/></strong></li><li class="checked" data-inline-task-id="18"><strong>Step 3 - As Vijay suggested - We started following the code flow step by step.</strong><br/><strong><br/></strong><ol><li><strong>In Freshsales - Scheduled sync is getting triggered? ---------------------------------- ✓</strong><br/><strong><br/></strong></li><li><strong>From Freshsales to Trinity - API hit - Working? ---------------------------------------- ✓<br/></strong><strong><br/></strong></li><li><strong>In Trinity logs - we went to modular level - Code is triggering start_sync function? ---- <strong>✓</strong></strong><br/><strong><strong><br/></strong></strong></li><li><strong><strong>By any chance is it going to rescue block? --------------------------------------------- <strong>✓<br/></strong></strong></strong><strong><strong><strong><br/></strong></strong></strong></li><li><strong><strong>We started logging the rescue block to see what is the error message and THERE IT IS  — </strong></strong></li></ol></li></ul></li></ul><blockquote><pre>              Errno::ENOSPC → As erroneous as it looks.</pre></blockquote><ul><li style="list-style-type: none;background-image: none;"><ul><li style="list-style-type: none;background-image: none;">Problem 1 - Basically - We create a error file CSV during the sync, just in case if some of the Google Contacts fail with some errors, we log into it and send to the customer. The files are deleted, but the empty folders aren't. </li></ul></li></ul><p style="list-style-type: none;background-image: none;margin-left: 120.0px;">For a day - 48 empty folders were getting created per customer .i.e.,</p><p style="list-style-type: none;background-image: none;margin-left: 120.0px;">~600x48x4Kb i.e., ~100Mb of data is getting stored unnecessarily per day.</p><p style="list-style-type: none;background-image: none;margin-left: 120.0px;">This sums up what can happen with just 1 empty folder which is mere 4Kb. Almost a 100Mb junk was getting occupied. On the outage day, it consumed all the space left in the disc. We haven't configured disk space alerts and that's the reason we weren't aware of the issue as in when it happened.</p><ul><li style="list-style-type: none;background-image: none;"><ul><li style="list-style-type: none;background-image: none;">Problem 2 - Rescue Exception captured this system error, so no error was seen in the logs - Rescuing exceptions are harmful(in cases). Good read about the different types of exceptions and when to use what - Thanks to Vaidhy and SivaKumar M. (<a href="https://www.honeybadger.io/blog/ruby-exception-vs-standarderror-whats-the-difference/" class="external-link" rel="nofollow">https://www.honeybadger.io/blog/ruby-exception-vs-standarderror-whats-the-difference/</a>)</li></ul></li></ul><h3 style="list-style-type: none;background-image: none;" id="Trinity-QuickfixesandRemedies:">Quick fixes and Remedies:</h3><ol><li>We have cleared the empty folders present in the tmp folder.</li><li>We have triggered the sync for all the accounts which went in the halted state with couple of scripts.</li><li>Added code to clear all the files created which consume space during the sync.</li><li>Added checks in the code to not allow suspended/cancelled accounts to enter the first phase of sync itself.</li><li>Adding all possible alerts(New Relic, Disk Space Alerts). And also check whether the details are correctly published to the Nagios and our infra team is tracking the same.</li><li>Adding loggers in the key places to get clear information.</li><li>Dedicating time with Continuing weekly sync ups to check the health of trinity.</li></ol><p><strong>People API Migration</strong></p><ol><li>All the sync labels from google contacts are fetched in FSA side and all the contact/leads parsing and fetch are done in Trinity side</li><li>The subsequent requests which are handled once in 30 min is done through sync_token</li><li>sync_token is fetched every time we hit trinity and store in table sync_settings under settings field</li><li>google_contacts.yml is maintained in Trinity .This can be used when more attributes are added or custom mappings are done for google contacts</li><li>We were noticing an outrage in the CPU due to heavy trinity usage . This was hit because the sync_token was corrupted and all the error codes were not handled</li></ol><h3 id="Trinity-RelatedTechdebtsandFRTickets">Related Tech debts and FR Tickets</h3><p style="margin-left: 40.0px;"><a href="https://freshworks.freshrelease.com/ws/FSALES/tasks/FSALES-38252" class="external-link" rel="nofollow">https://freshworks.freshrelease.com/ws/FSALES/tasks/FSALES-38252</a></p><p style="margin-left: 40.0px;"><a href="https://freshworks.freshrelease.com/ws/FSALES/tasks/FSALES-40769" class="external-link" rel="nofollow">https://freshworks.freshrelease.com/ws/FSALES/tasks/FSALES-40769</a></p><p style="margin-left: 40.0px;"><span style="color: rgb(29,28,29);">Trinity &amp; Multicurrency recording: </span><a href="https://freshworks.zoom.us/rec/share/LsR8vDLbd5mUgACzKwfGelWOAVDEhs2qJmxet7h6MaHi0yCv3tzOBHMOBN6muF8v.lWYyrqOncczrc6_A" style="text-decoration: none;text-align: left;" class="external-link" rel="nofollow">https://freshworks.zoom.us/rec/share/LsR8vDLbd5mUgACzKwfGelWOAVDEhs2qJmxet7h6MaHi0yCv3tzOBHMOBN6muF8v.lWYyrqOncczrc6_A</a><span style="color: rgb(29,28,29);"> </span><br style="text-align: left;"/><span style="color: rgb(29,28,29);">Passcode: Ct.6J$8W</span></p><p><br/></p><p style="margin-left: 30.0px;"><br/></p><p style="margin-left: 30.0px;"><br/></p><p style="margin-left: 30.0px;"><br/></p>