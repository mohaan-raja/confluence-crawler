<h1>Title: Docker usage documentation</h1><p><strong style="letter-spacing: 0.0px;">To make only freshsales run from the instance : </strong></p><blockquote><pre>docker-compose up -d</pre></blockquote><p>Here -d means detached. So that it won't exit when you press ctrl+c. (While initial setup i.e. building images, it will exit when you press ctrl+c.)</p><p>Use container logs to get the information regarding starting of containers.</p><p>Note* : Please use <strong>docker::deploy </strong>recipe from opsworks for clear deployment. This process is not going to deploy new code. It will restart all the stopped containers only.</p><p><strong style="letter-spacing: 0.0px;"><br/></strong></p><p><strong>To bootstrap database both admin console and main app via recipes (works only in stacks having docker_v3 recipes):</strong></p><p>Before doing bootstrap, there is a hack to perform. please do this first.</p><p>Comment out these 3 lines by editing <strong>/data/freshsales/config/environments/staging.rb</strong>.</p><blockquote><p># config.after_initialize do<br/>  # instrument<br/># end</p></blockquote><p>Stack → Run Command → Execute Recipes → <strong>docker::db_bootstrap</strong> with this custom json (Advanced → <label>Custom Chef JSON</label>) :</p><blockquote><p>{<br/>  &quot;bootstrap&quot;: {<br/>    &quot;apps&quot;: [<br/>      &quot;freshsales&quot;,<br/>      &quot;freshsales_admin&quot;<br/>    ],<br/>    &quot;domain&quot;: &quot;development&quot;,<br/>    &quot;email&quot;: &quot;madhava.sanikommu@freshworks.com&quot;<br/>  }<br/>}</p></blockquote><p><br/></p><p><strong style="letter-spacing: 0.0px;">Note* : </strong>Here sed -i will simply replace BOOTSTRAP variable in yml file. It means simply editing the file and changing it manually to TRUE. Run all these commands in bash.</p><p><strong style="letter-spacing: 0.0px;">To bootstrap database both admin console and main app:</strong></p><blockquote><p>sed -i 's/BOOTSTRAP=false/BOOTSTRAP=true/g' /data/freshsales/docker-compose.yml /data/freshsales_admin/docker-compose.yml</p><p><span style="color: rgb(112,112,112);">docker stop fs-web</span></p><p><span style="color: rgb(112,112,112);">docker stop fs-admin-web</span></p><p><span style="color: rgb(112,112,112);">sed -i 's/instrument/# instrument/' /data/freshsales/config/environments/staging.rb</span></p><p>docker-compose -f /data/freshsales/docker-compose.yml up -d</p><p>docker-compose -f /data/freshsales_admin/docker-compose.yml up -d</p><p>sed -i 's/BOOTSTRAP=true/BOOTSTRAP=false/g' /data/freshsales/docker-compose.yml /data/freshsales_admin/docker-compose.yml</p></blockquote><p><br/></p><p><strong>Main App Bootstrap :</strong></p><blockquote><p style="margin-left: 30.0px;"><span style="color: rgb(112,112,112);">sed -i 's/BOOTSTRAP=false/BOOTSTRAP=true/g' /data/freshsales/docker-compose.yml</span></p><p style="margin-left: 30.0px;"><span style="color: rgb(112,112,112);">docker stop fs-web<br/></span></p><p style="margin-left: 30.0px;"><span style="color: rgb(112,112,112);">sed -i 's/instrument/# instrument/' /data/freshsales/config/environments/staging.rb</span></p><p style="margin-left: 30.0px;"><span style="color: rgb(112,112,112);">docker-compose -f /data/freshsales/docker-compose.yml up -d</span></p><p style="margin-left: 30.0px;">sed -i 's/BOOTSTRAP=true/BOOTSTRAP=false/g' /data/freshsales/docker-compose.yml</p></blockquote><p><br/></p><p><strong>Admin Console Bootstrap :</strong></p><blockquote><p style="margin-left: 30.0px;"><span>sed -i 's/BOOTSTRAP=false/BOOTSTRAP=true/g' <span style="color: rgb(112,112,112);">/data/freshsales_admin/docker-compose.yml</span></span></p><p style="margin-left: 30.0px;"><span><span style="color: rgb(112,112,112);"><span style="color: rgb(112,112,112);">docker stop fs-admin-web</span><br/></span></span></p><p style="margin-left: 30.0px;"><span>docker-compose -f /data/freshsales/docker-compose.yml up -d</span></p><p style="margin-left: 30.0px;">sed -i 's/BOOTSTRAP=true/BOOTSTRAP=false/g' <span style="color: rgb(112,112,112);">/data/freshsales_admin/docker-compose.yml</span></p></blockquote><p><br/></p><p><strong style="letter-spacing: 0.0px;">To list containers :</strong></p><blockquote><pre>docker ps -a</pre></blockquote><p>Here -a is going to list stopped containers also. You can skip passing -a also.</p><p><br/></p><p><strong>To start/stop a container : </strong></p><blockquote><pre>docker start/stop &lt;container_id&gt;</pre></blockquote><p><br/></p><p><strong>To get in to the container : </strong></p><blockquote><pre>docker exec -it &lt;container_id&gt; &lt;command&gt;</pre></blockquote><p>Here command can be anything : bash, rails c, bundle exec rails c etc.</p><p><br/></p><p><strong>To get the logs from the container :</strong></p><blockquote><pre>docker logs --tail &lt;num_of_lines&gt; -f &lt;container_id&gt;</pre></blockquote><p>Here,</p><p>--tail &lt;num_of_lines&gt; going to get the last num_of lines you requested.</p><p>-f is going to follow the output of the docker container till it stopped.</p><p><br/></p><p><strong style="font-size: 20.0px;letter-spacing: 0.0px;">Advanced Material :</strong></p><p><strong><br/></strong></p><p><strong><strong>When you are getting fs_read_only not authorized to access database error : </strong></strong></p><p>Run this in mysql console or in sqlpro :  (get user, pass from stack settings and use host as instance IP)</p><blockquote><p>CREATE USER 'fs_readonly_user'@'%' IDENTIFIED BY '&lt;Password Here&gt;';<br/>GRANT SELECT ON *.* TO 'fs_readonly_user'@'%';<br/>GRANT EXECUTE ON *.* TO 'fs_readonly_user'@'%';<br/>FLUSH privileges;</p></blockquote><p><strong><br/></strong></p><p><strong>To List all the images :</strong></p><blockquote><pre>docker images</pre></blockquote><p><strong><br/></strong></p><p><strong>To delete a container :</strong></p><blockquote><pre>docker rm &lt;container_id&gt; &lt;container_id&gt; ...</pre></blockquote><p>Here, container_id(s) with spaces going to remove multiple containers at once.</p><p><br/></p><p><strong>To delete an image :</strong></p><blockquote><pre>docker rmi &lt;image_id&gt; &lt;image_id&gt; ...</pre></blockquote><p>Here, image_id(s) with spaces going to remove multiple images at once.</p><p><br/></p><p><strong>To boot up a new container so that you can debug the command thats causing its failure :</strong></p><blockquote><pre>docker run -it --rm &lt;image_id&gt; &lt;command&gt;</pre></blockquote><p>Here, </p><p>--rm means when you exit, remove the container created temporarily for debug purposes. if you didn't use it, it's going to be there permanently.</p><p>-it means interactive and tty based. So that it will allocate a tty for you and gives access to write and read from docker container.</p><p><br/></p><p><strong>Instance setup is hanged in opsworks : </strong></p><p>Login to the instance as root user and perform these tasks. This will be occured because of force killing of docker daemon. Because of force killing, Docker daemon can't able to write container's state info to files. So the state.json files in containerd folder won't exist hence the hang of all the docker commands. Fix is like : </p><blockquote><pre>service docker stop</pre><pre><span>rm -rf /var/run/docker/libcontainerd/containerd/*</span></pre><pre>service docker start </pre><pre>if [[ ! -z $(docker ps -aq) ]]; then docker rm $(docker ps -aq); fi; </pre></blockquote>