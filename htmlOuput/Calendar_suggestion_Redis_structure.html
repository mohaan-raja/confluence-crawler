<h1>Title: Calendar suggestion Redis structure</h1><p><br/><br/></p><p><span>For emails, one suggestion card </span></p><p><span>For  Leads/Contacts , suggestion card &lt;= emails associated to Lead</span></p><p><br/></p><p><strong><u>Redis Key structure</u> - </strong></p><p><u><strong>Email Conversation</strong></u></p><p><br/></p><p><span>Key_name:Acc_id:email_conversation_id= {</span></p><p><span>  </span> <span>“conversation_id” 123,</span></p><p><span>   ‘email_id’ : 8,</span></p><p><span> </span> <span> “start_date_time” : timestamp,</span></p><p><span>  “end_date_time: timestamp,</span></p><p><span> </span> <span> “timezone”: “”,</span></p><p><span> </span> <span> “entities”: [</span></p><p style="margin-left: 30.0px;"><span> { </span></p><p style="margin-left: 30.0px;"><span>entity_type: “Lead”, </span></p><p style="margin-left: 30.0px;"><span>entity_id: 123,</span></p><p style="margin-left: 30.0px;"><span>Is_primary: true</span></p><p style="margin-left: 30.0px;"><span> },</span></p><p style="margin-left: 30.0px;"><span>{ </span></p><p style="margin-left: 30.0px;"><span>entity_type: “Contact”, </span></p><p style="margin-left: 30.0px;"><span>entity_id: 124,</span></p><p style="margin-left: 30.0px;"><span>Is_primary: false</span></p><p style="margin-left: 30.0px;"><span> },</span></p><p style="margin-left: 30.0px;"><span>{ </span></p><p style="margin-left: 30.0px;"><span>entity_type: “User”, </span></p><p style="margin-left: 30.0px;"><span>entity_id: 5,</span></p><p style="margin-left: 30.0px;"><span>Is_primary: false</span></p><p style="margin-left: 30.0px;"><span> }</span></p><p><span>  ],</span></p><p><span> </span> <span> “expiry_date_time”: timestamp(utc)</span></p><p><span>}</span></p><p><br/><br/><br/></p><p><strong>Lead</strong></p><p><span>Key_name:Acc_id:Lead:Lead_id= {</span></p><p style="margin-left: 30.0px;"><span>email_ids: timestamp(start_time),</span></p><p style="margin-left: 30.0px;"><span>email_ids: timestamp(start_time)</span></p><p><span>}</span></p><p><br/><br/></p><p><span>Payload sent by ML team - </span></p><p><strong>CREATE/Update </strong><span>- will happen in sidekiq worker</span></p><p><span>Create - </span></p><ol><li><span>Create conversation key </span></li><li><span>Get primary entities, foreach : </span></li><ol><li><span>Check if lead_key exist, else create.</span></li><li><span>If lead_key exist</span></li><ol><li><span>Lead_key_expiry &gt;= conv_key_expiry</span></li><ol><li><span>Add key in lead hash</span></li></ol><li><span>Lead_key_expiry &lt; conv_key_expiry</span></li><ol><li><span>Update expiry</span></li><li><span>Add key in lead hash</span></li></ol></ol></ol></ol><p><br/><br/></p><p><span>Update: </span></p><ol><li><span> update_payload </span></li></ol><ol><li><span>Get primary entities, foreach : </span></li><ol><li><span>Check if lead_key exist, else create.</span></li><li><span>If lead_key exist</span></li><ol><li><span>Lead_key_expiry &gt;= conv_key_expiry</span></li><ol><li><span>Add key in lead hash</span></li></ol><li><span>Lead_key_expiry &lt; conv_key_expiry</span></li><ol><li><span>Update expiry</span></li><li><span>Add key in lead hash</span></li></ol></ol></ol></ol><p><br/><br/><br/></p><p><span>Cleanup: (will be done at the time of loading suggestion/expiry)</span></p><ol><li><span>Conv_key will be deleted by expiry</span></li><li><span>Lead_key will be deleted by expiry</span></li></ol><ol><li><span>On loading suggestion for leads - </span></li></ol><p><span>Check if key exists</span></p><ol><li><span>If key not exist, do zrem </span></li><li><span>If exist, process</span></li></ol><p><br/></p><ol><li><span> On status change, delete lead_key. // not needed will be handled by expiry time.</span></li></ol><p><br/><br/><br/></p><p><strong>Helpful redis commands - </strong></p><p><strong>$redis_freddy</strong><span>.zadd(</span><strong>'</strong><span>myzset</span><strong>'</strong><span>, </span><strong>5</strong><span>, </span><strong>'</strong><span>one</span><strong>'</strong><span>)</span></p><p><span>=&gt; </span><strong>true</strong></p><p><span>[5] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zadd(</span><strong>'</strong><span>myzset</span><strong>'</strong><span>, </span><strong>4</strong><span>, </span><strong>'</strong><span>two</span><strong>'</strong><span>)</span></p><p><span>=&gt; </span><strong>true</strong></p><p><span>[6] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zadd(</span><strong>'</strong><span>myzset</span><strong>'</strong><span>, </span><strong>3</strong><span>, </span><strong>'</strong><span>three</span><strong>'</strong><span>)</span></p><p><span>=&gt; </span><strong>true</strong></p><p><span>[7] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zadd(</span><strong>'</strong><span>myzset</span><strong>'</strong><span>, </span><strong>6</strong><span>, </span><strong>'</strong><span>six</span><strong>'</strong><span>)</span></p><p><span>=&gt; </span><strong>true</strong></p><p><span>[8] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zrangebyscore(</span><strong>'</strong><span>myzset</span><strong>'</strong><span>, </span><strong>'</strong><span>2</span><strong>'</strong><span>, </span><strong>'</strong><span>+inf</span><strong>'</strong><span>)</span></p><p><span>=&gt; [</span><strong>&quot;</strong><span>three</span><strong>&quot;</strong><span>, </span><strong>&quot;</strong><span>two</span><strong>&quot;</strong><span>, </span><strong>&quot;</strong><span>one</span><strong>&quot;</strong><span>, </span><strong>&quot;</strong><span>six</span><strong>&quot;</strong><span>]</span></p><p><span>[9] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zrangebyscore(</span><strong>'</strong><span>myzset</span><strong>'</strong><span>, </span><strong>'</strong><span>4</span><strong>'</strong><span>, </span><strong>'</strong><span>+inf</span><strong>'</strong><span>)</span></p><p><span>=&gt; [</span><strong>&quot;</strong><span>two</span><strong>&quot;</strong><span>, </span><strong>&quot;</strong><span>one</span><strong>&quot;</strong><span>, </span><strong>&quot;</strong><span>six</span><strong>&quot;</strong><span>]</span></p><p><span>[10] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zrangebyscore(</span><strong>'</strong><span>myzset</span><strong>'</strong><span>, </span><strong>'</strong><span>(4</span><strong>'</strong><span>, </span><strong>'</strong><span>+inf</span><strong>'</strong><span>)</span></p><p><span>=&gt; [</span><strong>&quot;</strong><span>one</span><strong>&quot;</strong><span>, </span><strong>&quot;</strong><span>six</span><strong>&quot;</strong><span>]</span></p><p><span>[11] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zrangebyscore(</span><strong>'</strong><span>myzset</span><strong>'</strong><span>, </span><strong>'</strong><span>9</span><strong>'</strong><span>, </span><strong>'</strong><span>+inf</span><strong>'</strong><span>)</span></p><p><span>=&gt; []</span></p><p><span>[12] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zrangebyscore(</span><strong>'</strong><span>myzset</span><strong>'</strong><span>, </span><strong>'</strong><span>0</span><strong>'</strong><span>, </span><strong>'</strong><span>+inf</span><strong>'</strong><span>)</span></p><p><span>=&gt; [</span><strong>&quot;</strong><span>three</span><strong>&quot;</strong><span>, </span><strong>&quot;</strong><span>two</span><strong>&quot;</strong><span>, </span><strong>&quot;</strong><span>one</span><strong>&quot;</strong><span>, </span><strong>&quot;</strong><span>six</span><strong>&quot;</strong><span>]</span></p><p><span>[13] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zadd(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>, </span><strong>'</strong><span>5</span><strong>'</strong><span>, </span><strong>'</strong><span>five</span><strong>'</strong><span>)</span></p><p><span>=&gt; </span><strong>true</strong></p><p><span>[14] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zadd(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>, </span><strong>'</strong><span>4</span><strong>'</strong><span>, </span><strong>'</strong><span>four</span><strong>'</strong><span>)</span></p><p><span>=&gt; </span><strong>true</strong></p><p><span>[15] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zadd(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>, </span><strong>'</strong><span>1</span><strong>'</strong><span>, </span><strong>'</strong><span>one</span><strong>'</strong><span>)</span></p><p><span>=&gt; </span><strong>true</strong></p><p><span>[16] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zadd(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>, </span><strong>'</strong><span>3</span><strong>'</strong><span>, </span><strong>'</strong><span>three</span><strong>'</strong><span>)</span></p><p><span>=&gt; </span><strong>true</strong></p><p><span>[17] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zrangebyscore(</span><strong>'</strong><span>myzset</span><strong>'</strong><span>, </span><strong>'</strong><span>2</span><strong>'</strong><span>, </span><strong>'</strong><span>+inf</span><strong>'</strong><span>)</span></p><p><span>=&gt; [</span><strong>&quot;</strong><span>three</span><strong>&quot;</strong><span>, </span><strong>&quot;</strong><span>two</span><strong>&quot;</strong><span>, </span><strong>&quot;</strong><span>one</span><strong>&quot;</strong><span>, </span><strong>&quot;</strong><span>six</span><strong>&quot;</strong><span>]</span></p><p><span>[18] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zrangebyscore(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>, </span><strong>'</strong><span>2</span><strong>'</strong><span>, </span><strong>'</strong><span>+inf</span><strong>'</strong><span>)</span></p><p><span>=&gt; [</span><strong>&quot;</strong><span>three</span><strong>&quot;</strong><span>, </span><strong>&quot;</strong><span>four</span><strong>&quot;</strong><span>, </span><strong>&quot;</strong><span>five</span><strong>&quot;</strong><span>]</span></p><p><span>[19] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zrangebyscore(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>, </span><strong>'</strong><span>4</span><strong>'</strong><span>, </span><strong>'</strong><span>+inf</span><strong>'</strong><span>)</span></p><p><span>=&gt; [</span><strong>&quot;</strong><span>four</span><strong>&quot;</strong><span>, </span><strong>&quot;</strong><span>five</span><strong>&quot;</strong><span>]</span></p><p><span>[20] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zrangebyscore(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>, </span><strong>'</strong><span>2</span><strong>'</strong><span>, </span><strong>'</strong><span>4</span><strong>'</strong><span>)</span></p><p><span>=&gt; [</span><strong>&quot;</strong><span>three</span><strong>&quot;</strong><span>, </span><strong>&quot;</strong><span>four</span><strong>&quot;</strong><span>]</span></p><p><span>[21] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zrangebyscore(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>, </span><strong>'</strong><span>1</span><strong>'</strong><span>, </span><strong>'</strong><span>4</span><strong>'</strong><span>)</span></p><p><span>=&gt; [</span><strong>&quot;</strong><span>one</span><strong>&quot;</strong><span>, </span><strong>&quot;</strong><span>three</span><strong>&quot;</strong><span>, </span><strong>&quot;</strong><span>four</span><strong>&quot;</strong><span>]</span></p><p><span>[22] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zrem(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>, [</span><strong>'</strong><span>one</span><strong>'</strong><span>, </span><strong>'</strong><span>four</span><strong>'</strong><span>, </span><strong>'</strong><span>five</span><strong>'</strong><span>])</span></p><p><span>=&gt; </span><strong>3</strong></p><p><span>[23] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zrangebyscore(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>, </span><strong>'</strong><span>1</span><strong>'</strong><span>, </span><strong>'</strong><span>4</span><strong>'</strong><span>)</span></p><p><span>=&gt; [</span><strong>&quot;</strong><span>three</span><strong>&quot;</strong><span>]</span></p><p><span>[24] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zrem(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>, [</span><strong>'</strong><span>three</span><strong>'</strong><span>, </span><strong>'</strong><span>two</span><strong>'</strong><span>])</span></p><p><span>=&gt; </span><strong>1</strong></p><p><span>[25] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.exists(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>)</span></p><p><span>=&gt; </span><strong>false</strong></p><p><span>[26] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.exists(</span><strong>'</strong><span>myzset</span><strong>'</strong><span>)</span></p><p><span>=&gt; </span><strong>true</strong></p><p><span>[27] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zrem(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>, [</span><strong>'</strong><span>three</span><strong>'</strong><span>, </span><strong>'</strong><span>two</span><strong>'</strong><span>])</span></p><p><span>=&gt; </span><strong>0</strong></p><p><span>[28] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.exists(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>)</span></p><p><span>=&gt; </span><strong>false</strong></p><p><span>[29] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zadd(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>, </span><strong>'</strong><span>1</span><strong>'</strong><span>, </span><strong>'</strong><span>one</span><strong>'</strong><span>)</span></p><p><span>=&gt; </span><strong>true</strong></p><p><span>[30] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.exists(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>)</span></p><p><span>=&gt; </span><strong>true</strong></p><p><span>[31] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zrem(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>, [</span><strong>'</strong><span>three</span><strong>'</strong><span>, </span><strong>'</strong><span>two</span><strong>'</strong><span>])</span></p><p><span>=&gt; </span><strong>0</strong></p><p><span>[32] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.exists(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>)</span></p><p><span>=&gt; </span><strong>true</strong></p><p><span>[33] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.zrem(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>, [</span><strong>'</strong><span>one</span><strong>'</strong><span>, </span><strong>'</strong><span>four</span><strong>'</strong><span>, </span><strong>'</strong><span>five</span><strong>'</strong><span>])</span></p><p><span>=&gt; </span><strong>1</strong></p><p><span>[34] pry(main)&gt; </span><strong>$redis_freddy</strong><span>.exists(</span><strong>'</strong><span>myzsetstr</span><strong>'</strong><span>)</span></p><p><span>=&gt; </span><strong>false</strong></p><p><span>[35] pry(main)&gt; </span></p>