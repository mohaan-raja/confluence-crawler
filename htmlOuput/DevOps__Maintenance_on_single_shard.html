<h1>Title: DevOps: Maintenance on single shard</h1><p>Pre-requisites:</p><ol><li>Post a schedule maintenance notification in status page.</li><li>Notify the customers using the in-app toaster</li><li>Before the day of maintenance, add a read-replica to the master instance with the new config.</li></ol><p><br/></p><p>Also post a scheduled maintenance notification in status page.</p><ol><li>Update scheduled maintenance in status page to Inprogress</li><li>Run the following in rails console to start maintenance on the shard's accounts<br/><ol><li>ShardMapping.unscoped.where(shard_name: '&lt;shard_name&gt;', status: ShardMapping::STATUS_CODE[:ok]).each {|sm| sm.status = ShardMapping::STATUS_CODE[:maintenance]; sm.save! }</li></ol></li><li>Wait for writes to stop by monitoring the WriteIOPS graph in RDS console</li><li>Promote the newly added slave to master.</li><li>Immediately modify the current master with the new config and chose the option &quot;Apply Immediately&quot;.</li><li><p class="auto-cursor-target">Run the following script to monitor instance availability of master and the promoted instance.<br/><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Ping RDS instance</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ruby; gutter: true; first-line: 1; theme: Confluence" data-theme="Confluence">def ping_mysql_server endpoint, password
puts &quot;Started pinging server : #{Time.now}&quot;

start_time = Time.now.to_i

while(Time.now.to_i - start_time &lt; 24*60*60 )
  response = `mysql -h #{endpoint} -u root -p#{password} -e &#39;show databases&#39;`
  result = response.include?(&quot;information_schema&quot;) ? &quot;UP&quot; : &quot;DOWN&quot;
  puts &quot;Server responded : #{Time.now} : #{result}&quot;
  sleep(1)
end

puts &quot;Stopped pinging server : #{Time.now}&quot;
end

</pre>
</div></div></li><li>Once the master instance is back up, stop the maintenance on the accounts<ol><li>ShardMapping.unscoped.where(shard_name: '&lt;shard_name&gt;', status: ShardMapping::STATUS_CODE[:maintenance]).each {|sm| sm.status = ShardMapping::STATUS_CODE[:ok]; sm.save! }</li></ol></li><li>If things go as planned, delete the promoted read replica.</li></ol><p><br/></p><p>*Â If the master instance is not coming back up on time or if there is any failure, also if the promoted instance has become the master successfully then update the dns to point to the new master and stop the maintenance.</p><p>Since there were no writes since the promotion, this instance will also be in-sync. Later on add slaves to this master and update them in route53.</p>