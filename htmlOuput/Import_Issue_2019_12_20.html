<h1>Title: Import Issue 2019-12-20</h1><p><strong>Cause of incident:</strong></p><p><span>Skip duplicates feature in import uses ElasticSearch to fetch records, when non-indexed column like work number or custom fields is chosen. Filter rules hash keys can be provided in both string and symbol format:</span></p><p><span>[{:attribute=&gt;&quot;work_number&quot;, :operator=&gt;&quot;is_in&quot;, :value=&gt;&quot;(368) 493-2361,(368) 493-2362,(368) 493-2363,(368) 493-2364,(368) 493-2365&quot;}]</span></p><p><span>[{&quot;attribute&quot;=&gt;&quot;work_number&quot;, &quot;operator&quot;=&gt;&quot;is_in&quot;, &quot;value&quot;=&gt;&quot;(368) 493-2361,(368) 493-2362,(368) 493-2363,(368) 493-2364,(368) 493-2365&quot;}]</span></p><p><span>As a part of new feature implementation, dropdown and radio type filters values were replaced with their id values. For the other types, no changes were made in filter values. This replacement of values were done only for hash keys in string format, which resulted in the following filter condition:</span></p><p><span>[{:attribute=&gt;&quot;work_number&quot;, :operator=&gt;&quot;is_in&quot;, :value=&gt;&quot;(368) 493-2361,(368) 493-2362,(368) 493-2363,(368) 493-2364,(368) 493-2365&quot;, &quot;value&quot; =&gt; nil}]</span></p><p><span>The skip duplicates feature, fetches records from elastic search in batch format in a loop. Each iteration in the loop, queries for records whose ids are greater than the last id of previous batch. However, the new feature implementation resulted in below filter rule:</span></p><p><span>[{:attribute=&gt;&quot;id&quot;, :operator=&gt;&quot;is_greater_than&quot;</span><strong>, :value=&gt;52, &quot;value&quot;:nil</strong><span>}]</span></p><p><span>This resulted in elastic search picking the values of id to be nil, resulting in an infinite loop.</span></p><p><strong>Impact of the incident:</strong></p><p><span>Import runs in the main app server when the number of records is less. Therefore, when import was triggered with skip duplicates option for few records, an infinite loop occured in the main app server. The app server had to restarted twice due to this.</span></p><p><strong>Actions taken during the incident:</strong></p><ol><li><span>The customers who had imported records with skip duplicates, were unable to do further imports. We had to change the status of the import to ‘failed’ and also clear redis key which contains of the recent import. This enabled customers to perform new imports.</span></li><li><span>We changed code changes, so that dropdown and radio type filters values replacement with their ids worked in both string and symbol format. The long running imports cleared after picking up the new code changes.</span></li></ol><p><strong>What could have prevented this:</strong></p><p><span>There was an import case in automation for skip duplicates, which we did not verify due to false failures.</span></p>